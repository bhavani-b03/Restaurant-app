<script>
let visitedFilterActive = false;

function toggleVisited(event) {
  event.preventDefault();

  const btn = event.currentTarget;
  const restaurantId = btn.dataset.id;

  fetch("{% url 'restaurants:toggle_visited' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ restaurant_id: restaurantId })
  })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
    const card = btn.closest(".restaurant-card");
    if (data.visited) {
        btn.textContent = "Unvisit";
        btn.classList.remove("bg-red-500", "hover:bg-red-600");
        btn.classList.add("bg-red-700", "hover:bg-red-800");
        if (card) card.dataset.visited = "true";
    } else {
        btn.textContent = "Visit";
        btn.classList.remove("bg-red-700", "hover:bg-red-800");
        btn.classList.add("bg-red-500", "hover:bg-red-600");
        if (card) card.dataset.visited = "false";
    }
    })
    .catch(error => {
    console.error('Failed to toggle visited status:', error);
    alert('Could not update visited status. Please try again later.');
    });
}

const visitedFilterBtn = document.getElementById("visitedFilterBtn");

visitedFilterBtn.addEventListener("click", () => {
  visitedFilterActive = !visitedFilterActive;

  visitedFilterBtn.querySelector("i")
    .classList.toggle("text-yellow-400", visitedFilterActive);

    document.querySelectorAll(".restaurant-card").forEach(card => {
        const link = card.closest("a");
        const isVisited = card.dataset.visited === "true";

        if (visitedFilterActive && !isVisited) {
            link.classList.add("hidden");
        } else {
            link.classList.remove("hidden");
        }
    });
});
</script>
<script>
const reviewPopup = document.getElementById("reviewPopup");
const reviewBtn = document.getElementById("writeReviewBtn");
const cancelReview = document.getElementById("cancelReview");
const starSelect = document.querySelectorAll("#starSelect i");
const ratingValue = document.getElementById("ratingValue");
const reviewForm = document.getElementById("reviewForm");

reviewBtn.addEventListener("click", () => {
  reviewPopup.classList.remove("hidden");
});

cancelReview.addEventListener("click", () => {
  reviewPopup.classList.add("hidden");
});

// Selecting rating stars (interactive)
starSelect.forEach(star => {
  star.addEventListener("click", () => {
    const value = star.dataset.value;
    ratingValue.value = value;

    starSelect.forEach(s => {
      if (s.dataset.value <= value) {
        s.classList.remove("text-gray-400");
        s.classList.add("text-yellow-400");
      } else {
        s.classList.add("text-gray-400");
        s.classList.remove("text-yellow-400");
      }
    });
  });
});

// Submit review
reviewForm.addEventListener("submit", function(e) {
  e.preventDefault();

  fetch("{% url 'restaurants:add_review' restaurant.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams(new FormData(reviewForm)),
  })
    .then(res => {
    if (!res.ok) {
      // If server returns an error, try to parse it as JSON
      return res.json().then(errorData => {
        throw new Error(errorData.error || `Server error: ${res.status}`);
      }).catch(() => {
        // If parsing fails, throw a generic error
        throw new Error(`Server error: ${res.status}`);
      });
    }
    return res.json();
  })
  .then(data => {
    if (data.success) {
      location.reload(); // refresh to show new review
    }
  })
  .catch(error => {
    console.error('Failed to submit review:', error);
    alert(`Error: ${error.message}`);
  });
});
</script>
