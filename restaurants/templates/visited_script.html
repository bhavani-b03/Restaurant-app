<script>
let visitedFilterActive = false;

function toggleVisited(event) {
  event.preventDefault();

  const btn = event.currentTarget;
  const restaurantId = btn.dataset.id;

  fetch("{% url 'restaurants:toggle_visited' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ restaurant_id: restaurantId })
  })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
    const card = btn.closest(".restaurant-card");
    if (data.visited) {
        btn.textContent = "Unvisit";
        btn.classList.remove("bg-red-500", "hover:bg-red-600");
        btn.classList.add("bg-red-700", "hover:bg-red-800");
        if (card) card.dataset.visited = "true";
    } else {
        btn.textContent = "Visit";
        btn.classList.remove("bg-red-700", "hover:bg-red-800");
        btn.classList.add("bg-red-500", "hover:bg-red-600");
        if (card) card.dataset.visited = "false";
    }
    })
    .catch(error => {
    console.error('Failed to toggle visited status:', error);
    alert('Could not update visited status. Please try again later.');
    });
}

const visitedFilterBtn = document.getElementById("visitedFilterBtn");

visitedFilterBtn.addEventListener("click", () => {
  visitedFilterActive = !visitedFilterActive;

  visitedFilterBtn.querySelector("i")
    .classList.toggle("text-yellow-400", visitedFilterActive);

    document.querySelectorAll(".restaurant-card").forEach(card => {
        const link = card.closest("a");
        const isVisited = card.dataset.visited === "true";

        if (visitedFilterActive && !isVisited) {
            link.classList.add("hidden");
        } else {
            link.classList.remove("hidden");
        }
    });
});
</script>
<script>
const reviewPopup = document.getElementById("reviewPopup");
const reviewBtn = document.getElementById("writeReviewBtn");
const cancelReview = document.getElementById("cancelReview");
const starSelect = document.querySelectorAll("#starSelect i");
const ratingValue = document.getElementById("ratingValue");
const reviewForm = document.getElementById("reviewForm");

reviewBtn.addEventListener("click", () => {
  reviewPopup.classList.remove("hidden");
});

cancelReview.addEventListener("click", () => {
  reviewPopup.classList.add("hidden");
});

// Selecting rating stars (interactive)
starSelect.forEach(star => {
  star.addEventListener("click", () => {
    const value = star.dataset.value;
    ratingValue.value = value;

    starSelect.forEach(s => {
      if (s.dataset.value <= value) {
        s.classList.remove("text-gray-400");
        s.classList.add("text-yellow-400");
      } else {
        s.classList.add("text-gray-400");
        s.classList.remove("text-yellow-400");
      }
    });
  });
});

// Submit review
reviewForm.addEventListener("submit", function(e) {
  e.preventDefault();
  fetch("{% url 'restaurants:add_review' restaurant.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams(new FormData(reviewForm)),
  })
    .then(res => {
    if (!res.ok) {
      // If server returns an error, try to parse it as JSON
      return res.json().then(errorData => {
        throw new Error(errorData.error || `Server error: ${res.status}`);
      }).catch(() => {
        // If parsing fails, throw a generic error
        throw new Error(`Server error: ${res.status}`);
      });
    }
    return res.json();
  })
  .then(data => {
    if (data.success) {
      location.reload(); // refresh to show new review
    }
  })
  .catch(error => {
    console.error('Failed to submit review:', error);
    alert(`Error: ${error.message}`);
  });
});

// Open popup for editing review
document.querySelectorAll(".edit-review-btn").forEach(btn => {
  btn.addEventListener("click", function(e) {
    const reviewId = this.dataset.reviewId;
    const reviewCard = this.closest(".review-card") || this.closest(".flex-1"); // your comment container

    // Get current rating and comment
    const rating = reviewCard.querySelector(".text-yellow-400 span")?.textContent || 0;
    const comment = reviewCard.querySelector(".review-comment")?.textContent.trim() || "";
    
    // Prefill form
    reviewForm.querySelector("#ratingValue").value = rating;
    reviewForm.querySelector("textarea[name='comment']").value = comment;

    // Set editId to distinguish update vs add
    reviewForm.dataset.editId = reviewId;

    // Update star UI
    starSelect.forEach(star => {
      const starValue = parseInt(star.dataset.value);
      if (starValue <= rating) {
        star.classList.remove("text-gray-400");
        star.classList.add("text-yellow-400");
      } else {
        star.classList.remove("text-yellow-400");
        star.classList.add("text-gray-400");
      }
    });

    // Show popup
    reviewPopup.classList.remove("hidden");
  });
});

document.querySelectorAll(".delete-review-btn").forEach(btn => {
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    
    if(!confirm("Are you sure you want to delete this review?")) return;

    const reviewId = this.dataset.reviewId;

    fetch("{% url 'restaurants:delete_review' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ review_id: reviewId })
    })
    .then(res => res.json())
    .then(data => {
    if (data.success) {
        const reviewCard = btn.closest(".review-card");
        if(reviewCard) reviewCard.remove();

        // Update average rating dynamically
        const avgEl = document.getElementById("avg-rating");
        if(avgEl && data.average_rating) avgEl.textContent = data.average_rating;

        const countEl = document.getElementById("review-count");
        if(countEl && data.review_count) countEl.textContent = data.review_count;
    } else {
        alert("Failed to delete review.");
    }
    })
    .catch(err => {
      console.error("Error deleting review:", err);
      alert("Something went wrong.");
    });
  });
});
</script>
