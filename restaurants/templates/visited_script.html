<script>
let visitedFilterActive = false;

function toggleVisited(event) {
  event.preventDefault();

  const btn = event.currentTarget;
  const restaurantId = btn.dataset.id;

  fetch("{% url 'restaurants:toggle_visited' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ restaurant_id: restaurantId })
  })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
    const card = btn.closest(".restaurant-card");
    if (data.visited) {
        btn.textContent = "Unvisit";
        btn.classList.remove("bg-red-500", "hover:bg-red-600");
        btn.classList.add("bg-red-700", "hover:bg-red-800");
        if (card) card.dataset.visited = "true";
    } else {
        btn.textContent = "Visit";
        btn.classList.remove("bg-red-700", "hover:bg-red-800");
        btn.classList.add("bg-red-500", "hover:bg-red-600");
        if (card) card.dataset.visited = "false";
    }
    })
    .catch(error => {
    console.error('Failed to toggle visited status:', error);
    alert('Could not update visited status. Please try again later.');
    });
}

const visitedFilterBtn = document.getElementById("visitedFilterBtn");

visitedFilterBtn.addEventListener("click", () => {
  visitedFilterActive = !visitedFilterActive;

  visitedFilterBtn.querySelector("i")
    .classList.toggle("text-yellow-400", visitedFilterActive);

    document.querySelectorAll(".restaurant-card").forEach(card => {
        const link = card.closest("a");
        const isVisited = card.dataset.visited === "true";

        if (visitedFilterActive && !isVisited) {
            link.classList.add("hidden");
        } else {
            link.classList.remove("hidden");
        }
    });
});
</script>
